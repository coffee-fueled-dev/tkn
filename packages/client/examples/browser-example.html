<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKN Browser Client Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        input,
        textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group {
            margin: 10px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>TKN Browser Client Example</h1>

        <div id="status" class="status disconnected">Disconnected</div>

        <div class="form-group">
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="ws://localhost:4001" style="width: 300px;">
        </div>

        <div>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <div class="form-group">
            <label for="jsonInput">Send JSON:</label>
            <textarea id="jsonInput" rows="3"
                style="width: 100%;">{"message": "Hello from browser!", "timestamp": "2024-01-01"}</textarea>
            <button id="sendJsonBtn" disabled>Send JSON</button>
        </div>

        <div class="form-group">
            <label for="stringInput">Send String:</label>
            <input type="text" id="stringInput" value="Hello TKN Server!" style="width: 300px;">
            <button id="sendStringBtn" disabled>Send String</button>
        </div>

        <div class="form-group">
            <button id="sendBatchBtn" disabled>Send Mixed Batch</button>
        </div>

        <div class="form-group">
            <label>Activity Log:</label>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        // Import the focused browser client
        import { TknBrowserClient, TYPE_JSON, TYPE_STRING, TYPE_BINARY } from '../src/browser.js';

        let client = null;

        // DOM elements
        const statusEl = document.getElementById('status');
        const serverUrlEl = document.getElementById('serverUrl');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const jsonInputEl = document.getElementById('jsonInput');
        const sendJsonBtn = document.getElementById('sendJsonBtn');
        const stringInputEl = document.getElementById('stringInput');
        const sendStringBtn = document.getElementById('sendStringBtn');
        const sendBatchBtn = document.getElementById('sendBatchBtn');
        const logEl = document.getElementById('log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(connected) {
            if (connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendJsonBtn.disabled = false;
                sendStringBtn.disabled = false;
                sendBatchBtn.disabled = false;
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendJsonBtn.disabled = true;
                sendStringBtn.disabled = true;
                sendBatchBtn.disabled = true;
            }
        }

        connectBtn.addEventListener('click', async () => {
            const url = serverUrlEl.value;
            log(`Connecting to ${url}...`);

            client = new TknBrowserClient({
                url: url,
                onConnect: (client) => {
                    log('‚úÖ Connected to TKN server!');
                    updateStatus(true);
                },
                onData: (data) => {
                    const response = new TextDecoder().decode(data);
                    log(`‚Üê Server: ${response}`);
                },
                onError: (error) => {
                    log(`‚ùå Error: ${error.type || 'Connection error'}`);
                },
                onClose: (event) => {
                    log(`üîí Connection closed (code: ${event.code})`);
                    updateStatus(false);
                }
            });

            const connected = await client.connect();
            if (!connected) {
                log('‚ùå Failed to connect');
                client = null;
            }
        });

        disconnectBtn.addEventListener('click', () => {
            if (client) {
                log('Disconnecting...');
                client.disconnect();
                client = null;
                updateStatus(false);
            }
        });

        sendJsonBtn.addEventListener('click', () => {
            if (client) {
                try {
                    const jsonData = JSON.parse(jsonInputEl.value);
                    const success = client.sendJson(jsonData);
                    log(`‚Üí Sent JSON: ${success ? '‚úÖ' : '‚ùå'} ${jsonInputEl.value}`);
                } catch (error) {
                    log(`‚ùå Invalid JSON: ${error.message}`);
                }
            }
        });

        sendStringBtn.addEventListener('click', () => {
            if (client) {
                const text = stringInputEl.value;
                const success = client.sendString(text);
                log(`‚Üí Sent string: ${success ? '‚úÖ' : '‚ùå'} "${text}"`);
            }
        });

        sendBatchBtn.addEventListener('click', () => {
            if (client) {
                const batchItems = [
                    { type: TYPE_STRING, data: "First item" },
                    { type: TYPE_JSON, data: { batch: true, count: 2 } },
                    { type: TYPE_STRING, data: "Third item" },
                    { type: TYPE_BINARY, data: new TextEncoder().encode("Binary data") }
                ];

                const success = client.sendBatch(batchItems);
                log(`‚Üí Sent batch: ${success ? '‚úÖ' : '‚ùå'} ${batchItems.length} items`);
            }
        });

        // Initialize UI
        updateStatus(false);
        log('TKN Browser Client ready');
    </script>
</body>

</html>